name: Check Terraform Usage Block

on:
  pull_request:
    paths:
      - 'variables.tf'
      - 'README.md'
      - '.github/workflows/check-terraform-usage.yml'
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  check-usage-block:
    runs-on: ubuntu-latest
    name: Validate Terraform Usage Documentation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Terraform Usage Block
        uses: ./
        with:
          mode: 'check'
          directory: '.'
          fail-on-diff: 'true'
      
      - name: Comment on PR (if check fails)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Terraform Usage Block Out of Date**\n\n' +
                    'The usage block in `README.md` is not up-to-date with `variables.tf`.\n\n' +
                    'Please run the following command to update it:\n' +
                    '```bash\npython3 terraform_usage_gen.py\n```\n\n' +
                    'Then commit the changes to `README.md`.'
            })
